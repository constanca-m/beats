version: '3'

env:
  # version of the stack to prepare the environment
  STACK_VERSION: 8.12.0-SNAPSHOT


tasks:
  main:
    cmds:
      - task: create-cluster
      - task: delete-metricbeat
      - task: deploy-metricbeat
      - task: build-metricbeat
      - task: exec-metricbeat

  prepare-env:
    cmds:
      - elastic-package stack up -v -d --version=$STACK_VERSION
      - kind create cluster --config=kind-config.yaml
      - docker network connect elastic-package-stack_default kind-control-plane
      - kubectl apply -k https://github.com/kubernetes/kube-state-metrics

  delete-metricbeat:
    dir: ./01_playground
    cmds:
      - kubectl delete -f metricbeat.yaml

  build-and-deploy-metricbeat:
    cmds:
      - task: build-metricbeat
      - task: deploy-metricbeat

  deploy-metricbeat:
    dir: ./01_playground
    cmds:
      - kubectl apply -f metricbeat.yaml

  build-metricbeat:
    dir: ../../../../..
    cmds:
      - GOOS=linux GOARCH=amd64 go build

  copy-and-exec-metricbeat:
    dir: ../../../../..
    cmds:
      - kubectl cp ./metricbeat `kubectl get pod -n kube-system -l k8s-app=metricbeat -o jsonpath='{.items[].metadata.name}'`:/usr/share/metricbeat/ -n kube-system
      - kubectl exec `kubectl get pod -n kube-system -l k8s-app=metricbeat -o jsonpath='{.items[].metadata.name}'` -n kube-system -- bash -c "metricbeat -e -c /etc/metricbeat.yml" #&> outputfile.txt
